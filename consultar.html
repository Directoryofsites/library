<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar - Lumen Logos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .search-container {
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--primary-color);
            border-right: none;
            border-radius: 5px 0 0 5px;
            font-size: 16px;
        }
        
        .search-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
        }
        
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .search-options {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 15px;
}

.search-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    color: var(--primary-color);
    font-weight: 500;
}

.search-option input[type="radio"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.search-option:hover {
    color: var(--secondary-color);
}
        
        .filter-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            min-width: 200px;
        }
        
        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .filter-options {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .filter-option input {
            margin-right: 8px;
        }
        
        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .document-card {
            border: 1px solid #eee;
            border-radius: 5px;
            overflow: hidden;
            transition: all 0.3s ease;
            background-color: white;
        }
        
        .document-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }
        
        .document-card-content {
            padding: 20px;
        }
        
        .document-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .document-description {
            color: var(--tertiary-color);
            margin-bottom: 15px;
        }
        
        .document-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .document-tag {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .document-view-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .document-view-btn:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
        }
        
               
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 50px;
        }
        
        .pagination-btn {
            padding: 8px 15px;
            margin: 0 5px;
            border: 1px solid var(--primary-color);
            background-color: white;
            color: var(--primary-color);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pagination-btn:hover, .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .no-results {
            text-align: center;
            padding: 50px;
            color: var(--tertiary-color);
        }

 /* Estilos Modal Login */
.login-modal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.login-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 300px;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-modal:hover {
    color: black;
}

.login-form {
    margin-top: 20px;
}

.login-form input {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.login-form button {
    width: 100%;
    padding: 10px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.login-form button:hover {
    background-color: var(--secondary-color);
    color: var(--primary-color);
}

.login-error {
    color: #d9534f;
    margin-top: 10px;
    text-align: center;
}


.filter-selector {
    margin-bottom: 15px;
}

.selector-group {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
}

.category-select, .tag-select {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    color: var(--primary-color);
}

.add-tag-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.add-tag-btn:hover {
    background-color: var(--secondary-color);
    color: var(--primary-color);
}

.add-tag-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    color: #666;
}

.selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.tag-item {
    display: flex;
    align-items: center;
    background-color: var(--secondary-color);
    color: var(--primary-color);
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
}

.tag-remove {
    margin-left: 5px;
    cursor: pointer;
    font-size: 14px;
}

.tag-remove:hover {
    color: #d9534f;
}

/* Responsive para el filtro de categorías y etiquetas */
@media (max-width: 768px) {
    .selector-group {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .category-select, .tag-select {
        width: 100%;
    }
    
    .add-tag-btn {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
    }
    
    .filter-box {
        min-width: auto;
        width: 100%;
    }
    
    .filter-container {
        justify-content: stretch;
    }
}

    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <!-- Navigation will be generated by JavaScript -->
    </header>
    <!-- Main Content -->
    <section class="page-content" style="margin-top: 150px; padding: 50px 0;">
        <div class="container">
            <h2 class="text-center mb-5">Archivo de Reflexiones Bíblicas</h2>
            
          <!-- Search -->
<div class="search-container">
    <div class="search-box">
        <input type="text" id="search-input" class="search-input" placeholder="Ingresa tu término de búsqueda...">
        <button id="search-btn" class="search-btn">
            <i class="fas fa-search"></i>
        </button>
    </div>
    <!-- Nuevas opciones de búsqueda -->
    <div class="search-options">
        <label class="search-option">
            <input type="radio" name="search-type" value="title" id="search-title" checked>
            <span>Buscar por título</span>
        </label>
        <label class="search-option">
            <input type="radio" name="search-type" value="content" id="search-content">
            <span>Buscar por contenido</span>
        </label>
    </div>
</div>
            
           <!-- Filters -->
<div class="filter-container">
    <div class="filter-box">
        <div class="filter-title">Filtrar por categoría y etiqueta</div>
        <div class="filter-selector">
            <div class="selector-group">
                <select id="category-dropdown" class="category-select">
                    <option value="">Selecciona una categoría</option>
                    <!-- Categorías se cargarán dinámicamente -->
                </select>
                <select id="tag-dropdown" class="tag-select" disabled>
                    <option value="">Selecciona una etiqueta</option>
                    <!-- Etiquetas se cargarán dinámicamente según la categoría -->
                </select>
                <button id="add-tag-btn" class="add-tag-btn" disabled>
                    <i class="fas fa-plus"></i> Agregar
                </button>
            </div>
        </div>
        <div id="selected-tags" class="selected-tags">
            <!-- Aquí se mostrarán las etiquetas seleccionadas -->
        </div>
    </div>
</div>
            
            <!-- Results -->
            <div class="results-container" id="results">
                <!-- Los resultados se cargarán dinámicamente -->
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <!-- La paginación se generará dinámicamente -->
            </div>
                      
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-top">
                <div class="footer-info">
                    <div class="footer-logo">
                        <img src="images/logo-lumen-logos.svg" alt="Lumen Logos">
                    </div>
                    <div class="footer-contact">
                        <div class="footer-contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <p></p>
                                <p></p>
                            </div>
                        </div>
                        <div class="footer-contact-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <p></p>
                            </div>
                        </div>
                        <div class="footer-contact-item">
                            <i class="fas fa-envelope"></i>
                            <div>
                                <p></p>
                            </div>
                        </div>
                    </div>
                    <div class="footer-social">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-links">
                    <h3 class="footer-title">Links rápidos</h3>
                    <ul>
                        <li><a href="about.html">Acerca de nosotros</a></li>
                        <li><a href="programs.html">Conocimiento</a></li>
                        <li><a href="faculty.html">Enlaces</a></li>
                        <li><a href="admissions.html">Títulos</a></li>
                        <li><a href="resources.html">Buscar</a></li>
                        <li><a href="contact.html">Contacto</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3 class="footer-title">Recursos</h3>
                    <ul>
                        <li><a href="library.html">Biblioteca</a></li>
                        <li><a href="blog.html">Blog</a></li>
                        <li><a href="events.html">Eventos</a></li>
                        <li><a href="#">Recursos de estudio</a></li>
                        <li><a href="#">Centro de ayuda</a></li>
                    </ul>
                </div>
                <div class="footer-newsletter">
                    <h3 class="footer-title">Recibir novedades</h3>
                    <p>Suscríbete para recibir actualizaciones sobre nuevos recursos y eventos.</p>
                    <form>
                        <input type="email" placeholder="Tu correo electrónico" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-radius: 5px;">
                        <button type="submit" class="btn btn-secondary" style="width: 100%;">Suscribirse</button>
                    </form>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Lumen Logos. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="js/tag-handler.js"></script>
    <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/scripts.js"></script>
<script>
    // Importar cliente de Supabase desde el archivo de configuración
const SUPABASE_URL = 'https://cjhbhfvkcwwpnhqixlwd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqaGJoZnZrY3d3cG5ocWl4bHdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIzMTk2MjQsImV4cCI6MjA1Nzg5NTYyNH0.Db6b_riMZXmM09Bfav-iHtJBaSMX31j-eGPgnaAbI80';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Variables para la paginación
    let currentPage = 1;
    let totalDocuments = 0;
    let documentsPerPage = 9;
    let allDocuments = [];

    // Verificar estado de login al cargar la página
const isLoggedIn = localStorage.getItem('isAdmin') === 'true';
    
    // Cargar datos al iniciar la página
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await loadCategories();
        
        // Verificar si hay parámetros de URL (etiquetas o fechas)
        const urlParams = new URLSearchParams(window.location.search);
        const hasDateFilter = urlParams.get('date_type');
        const hasTagFilter = urlParams.get('tags');
        
        if (hasDateFilter) {
            // Si hay filtro de fecha, procesarlo primero
            checkForDateFilters();
        } else if (hasTagFilter) {
            // Si hay filtro de etiquetas, procesarlo
            checkForPreselectedTags();
        } else {
            // Si no hay filtros, cargar documentos normalmente
            await loadDocuments();
        }
        
    } catch (error) {
        console.error('Error al cargar datos iniciales:', error);
        loadSampleData();
    }
});    

// Re-initialize search menu after page loads
setTimeout(() => {
    if (typeof initSearchMenu === 'function') {
        initSearchMenu();
    }
}, 500);

// Función para manejar etiquetas preseleccionadas desde URL
function checkForPreselectedTags() {
    const urlParams = new URLSearchParams(window.location.search);
    const preselectedTags = urlParams.get('tags');
    
    if (preselectedTags) {
        const tagIds = preselectedTags.split(',').map(id => parseInt(id.trim()));
        
        // Agregar las etiquetas a la selección actual
        tagIds.forEach(tagId => {
            if (!selectedTagIds.includes(tagId)) {
                selectedTagIds.push(tagId);
                
                // Buscar información de la etiqueta
                const tag = allTags.find(t => t.id === tagId);
                if (tag) {
                    // Crear elemento visual para la etiqueta
                    const selectedTags = document.getElementById('selected-tags');
                    const tagItem = document.createElement('div');
                    tagItem.className = 'tag-item';
                    tagItem.dataset.id = tagId;
                    tagItem.innerHTML = `
                        ${tag.name}
                        <span class="tag-remove" data-id="${tagId}">✕</span>
                    `;
                    
                    // Agregar evento para eliminar
                    tagItem.querySelector('.tag-remove').addEventListener('click', function() {
                        const tagIdToRemove = parseInt(this.dataset.id);
                        selectedTagIds = selectedTagIds.filter(id => id !== tagIdToRemove);
                        this.parentElement.remove();
                        applyFilters();
                    });
                    
                    selectedTags.appendChild(tagItem);
                }
            }
        });
        
        // Aplicar filtros automáticamente si hay etiquetas
        if (selectedTagIds.length > 0) {
            setTimeout(() => {
                applyFilters();
            }, 500); // Pequeño delay para asegurar que todo esté cargado
        }
    }
}

// Verificar si hay filtros de fecha desde la URL
        checkForDateFilters();

// Filtrar documentos por año
async function filterDocumentsByYear(year) {
    try {
        console.log('Filtrando documentos por año:', year);
        
        // Crear fechas de inicio y fin del año
        const startDate = `${year}-01-01T00:00:00`;
        const endDate = `${year}-12-31T23:59:59`;
        
        const { data, error } = await supabase
            .from('documents')
            .select('*')
            .gte('created_at', startDate)
            .lte('created_at', endDate)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const filteredDocs = data || [];
        console.log(`Documentos encontrados en ${year}:`, filteredDocs.length);
        
        // Actualizar resultados
        allDocuments = filteredDocs;
        totalDocuments = filteredDocs.length;
        renderDocuments(filteredDocs.slice(0, documentsPerPage));
        generatePagination(totalDocuments, documentsPerPage, 1);
        currentPage = 1;
        
        // Mostrar mensaje informativo
        showDateFilterMessage(`Mostrando documentos del año ${year} (${filteredDocs.length} resultados)`);
        
    } catch (error) {
        console.error('Error al filtrar por año:', error);
        showDateFilterMessage('Error al aplicar filtro de año', true);
    }
}

// Filtrar documentos por mes
async function filterDocumentsByMonth(year, month) {
    try {
        console.log('Filtrando documentos por mes:', `${month}/${year}`);
        
        // Crear fechas de inicio y fin del mes
        const startDate = `${year}-${month.toString().padStart(2, '0')}-01T00:00:00`;
        const lastDay = new Date(year, month, 0).getDate();
        const endDate = `${year}-${month.toString().padStart(2, '0')}-${lastDay}T23:59:59`;
        
        const { data, error } = await supabase
            .from('documents')
            .select('*')
            .gte('created_at', startDate)
            .lte('created_at', endDate)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const filteredDocs = data || [];
        const monthNames = ['', 'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                           'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        
        console.log(`Documentos encontrados en ${monthNames[month]} ${year}:`, filteredDocs.length);
        
        // Actualizar resultados
        allDocuments = filteredDocs;
        totalDocuments = filteredDocs.length;
        renderDocuments(filteredDocs.slice(0, documentsPerPage));
        generatePagination(totalDocuments, documentsPerPage, 1);
        currentPage = 1;
        
        // Mostrar mensaje informativo
        showDateFilterMessage(`Mostrando documentos de ${monthNames[month]} ${year} (${filteredDocs.length} resultados)`);
        
    } catch (error) {
        console.error('Error al filtrar por mes:', error);
        showDateFilterMessage('Error al aplicar filtro de mes', true);
    }
}

// Filtrar documentos por día específico
async function filterDocumentsByDay(date) {
    try {
        console.log('Filtrando documentos por día:', date);
        
        // Crear fechas de inicio y fin del día
        const startDate = `${date}T00:00:00`;
        const endDate = `${date}T23:59:59`;
        
        const { data, error } = await supabase
            .from('documents')
            .select('*')
            .gte('created_at', startDate)
            .lte('created_at', endDate)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const filteredDocs = data || [];
        console.log(`Documentos encontrados el ${date}:`, filteredDocs.length);
        
        // Actualizar resultados
        allDocuments = filteredDocs;
        totalDocuments = filteredDocs.length;
        renderDocuments(filteredDocs.slice(0, documentsPerPage));
        generatePagination(totalDocuments, documentsPerPage, 1);
        currentPage = 1;
        
        // Formatear fecha para mostrar
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        
        // Mostrar mensaje informativo
        showDateFilterMessage(`Mostrando documentos del ${formattedDate} (${filteredDocs.length} resultados)`);
        
    } catch (error) {
        console.error('Error al filtrar por día:', error);
        showDateFilterMessage('Error al aplicar filtro de día', true);
    }
}

// Mostrar mensaje informativo de filtro de fecha
function showDateFilterMessage(message, isError = false) {
    // Remover mensaje anterior si existe
    const existingMessage = document.querySelector('.date-filter-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    // Crear nuevo mensaje
    const messageDiv = document.createElement('div');
    messageDiv.className = `date-filter-message ${isError ? 'error' : 'info'}`;
    messageDiv.style.cssText = `
        background-color: ${isError ? '#f8d7da' : '#d1ecf1'};
        color: ${isError ? '#721c24' : '#0c5460'};
        padding: 10px 15px;
        margin: 20px 0;
        border-radius: 5px;
        text-align: center;
        font-weight: 500;
        border: 1px solid ${isError ? '#f5c6cb' : '#bee5eb'};
    `;
    
    messageDiv.innerHTML = `
        <i class="fas fa-${isError ? 'exclamation-triangle' : 'info-circle'}"></i> 
        ${message}
        <button onclick="this.parentElement.remove()" style="
            float: right; 
            background: none; 
            border: none; 
            color: inherit; 
            cursor: pointer;
            font-size: 16px;
        ">×</button>
    `;
    
    // Insertar después del contenedor de búsqueda
    const searchContainer = document.querySelector('.search-container');
    searchContainer.insertAdjacentElement('afterend', messageDiv);
    
    // Auto-remover después de 10 segundos si no es error
    if (!isError) {
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 10000);
    }
}

// Función para manejar filtros de fecha desde URL
function checkForDateFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    const dateType = urlParams.get('date_type');
    
    if (dateType) {
        console.log('Filtro de fecha detectado:', dateType);
        
        if (dateType === 'year') {
            const year = urlParams.get('year');
            if (year) {
                filterDocumentsByYear(parseInt(year));
            }
        } else if (dateType === 'month') {
            const year = urlParams.get('year');
            const month = urlParams.get('month');
            if (year && month) {
                filterDocumentsByMonth(parseInt(year), parseInt(month));
            }
        } else if (dateType === 'day') {
            const date = urlParams.get('date');
            if (date) {
                filterDocumentsByDay(date);
            }
        }
    }
}

    // Agregar evento al botón de agregar etiqueta
document.getElementById('add-tag-btn').addEventListener('click', addTagToSelection);
    
    // Variables para almacenar categorías y etiquetas
let allCategories = [];
let allTags = [];
let selectedTagIds = [];

// Función auxiliar para manejar etiquetas (copiada de scripts.js)
function getDocumentTags(doc) {
    if (doc.tags_array && Array.isArray(doc.tags_array)) {
        return doc.tags_array.map(tag => Number(tag));
    }
    
    if (!doc || !doc.tags) return [];
    
    if (Array.isArray(doc.tags)) {
        return doc.tags.map(tag => Number(tag));
    }
    
    if (typeof doc.tags === 'number' || typeof doc.tags === 'string') {
        return [Number(doc.tags)];
    }
    
    return [Number(doc.tags)];
}

// Cargar solo categorías que tienen etiquetas con documentos asignados
async function loadCategories() {
    try {
        // Obtener todas las etiquetas usadas en documentos
        const { data: documents, error: docsError } = await supabase
            .from('documents')
            .select('tags_array');
            
        if (docsError) throw docsError;
        
        // Extraer todas las etiquetas únicas en uso
        const usedTagIds = new Set();
        documents.forEach(doc => {
            const tags = getDocumentTags(doc);
            tags.forEach(tagId => usedTagIds.add(tagId));
        });
        
        // Obtener información de categorías y etiquetas
        const { data: categories, error: catError } = await supabase
            .from('categories')
            .select('*')
            .order('name');
            
        const { data: tags, error: tagsError } = await supabase
            .from('tags')
            .select('*')
            .order('name');
            
        if (catError) throw catError;
        if (tagsError) throw tagsError;
        
        // Filtrar solo etiquetas que están en uso
        const usedTags = tags.filter(tag => usedTagIds.has(tag.id));
        
        // Filtrar solo categorías que tienen etiquetas en uso
        const categoriesWithUsedTags = categories.filter(category => 
            usedTags.some(tag => tag.category_id === category.id)
        );
        
        allCategories = categoriesWithUsedTags || [];
        allTags = usedTags || [];
        
        const categoryDropdown = document.getElementById('category-dropdown');
        categoryDropdown.innerHTML = '<option value="">Selecciona una categoría</option>';
        
        categoriesWithUsedTags.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categoryDropdown.appendChild(option);
        });
        
        // Agregar evento de cambio
        categoryDropdown.addEventListener('change', handleCategoryChange);
        
    } catch (error) {
        console.error('Error al cargar categorías:', error);
        throw error;
    }
}


// Manejar cambio de categoría
function handleCategoryChange() {
    const categoryId = document.getElementById('category-dropdown').value;
    const tagDropdown = document.getElementById('tag-dropdown');
    const addTagBtn = document.getElementById('add-tag-btn');
    
    // Limpiar y deshabilitar el menú de etiquetas si no hay categoría seleccionada
    if (!categoryId) {
        tagDropdown.innerHTML = '<option value="">Selecciona una etiqueta</option>';
        tagDropdown.disabled = true;
        addTagBtn.disabled = true;
        return;
    }
    
    // Filtrar etiquetas por categoría seleccionada
    const categoryTags = allTags.filter(tag => tag.category_id == categoryId);
    tagDropdown.innerHTML = '<option value="">Selecciona una etiqueta</option>';
    
    // Ordenar etiquetas alfabéticamente
    categoryTags.sort((a, b) => a.name.localeCompare(b.name));
    
    // Agregar etiquetas al menú desplegable
    categoryTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag.id;
        option.textContent = tag.name;
        tagDropdown.appendChild(option);
    });
    
    // Habilitar el menú de etiquetas
    tagDropdown.disabled = false;
    
    // Agregar evento al menú de etiquetas
    tagDropdown.addEventListener('change', handleTagChange);
}

// Manejar cambio de etiqueta
function handleTagChange() {
    const tagId = document.getElementById('tag-dropdown').value;
    const addTagBtn = document.getElementById('add-tag-btn');
    
    // Habilitar o deshabilitar el botón según si hay una etiqueta seleccionada
    addTagBtn.disabled = !tagId;
}

// Agregar etiqueta a la selección
function addTagToSelection() {
    const tagDropdown = document.getElementById('tag-dropdown');
    const tagId = tagDropdown.value;
    
    if (!tagId) return;
    
    // Evitar duplicados
    if (selectedTagIds.includes(parseInt(tagId))) {
        alert('Esta etiqueta ya está seleccionada');
        return;
    }
    
    const selectedTag = allTags.find(tag => tag.id == tagId);
    const selectedTags = document.getElementById('selected-tags');
    
    // Crear elemento visual para la etiqueta seleccionada
    const tagItem = document.createElement('div');
    tagItem.className = 'tag-item';
    tagItem.dataset.id = tagId;
    tagItem.innerHTML = `
        ${selectedTag.name}
        <span class="tag-remove" data-id="${tagId}">✕</span>
    `;
    
    // Agregar evento para eliminar la etiqueta
    tagItem.querySelector('.tag-remove').addEventListener('click', function() {
        const tagIdToRemove = parseInt(this.dataset.id);
        selectedTagIds = selectedTagIds.filter(id => id !== tagIdToRemove);
        this.parentElement.remove();
        applyFilters();
    });
    
    // Agregar al DOM y a la lista de etiquetas seleccionadas
    selectedTags.appendChild(tagItem);
    selectedTagIds.push(parseInt(tagId));
    
    // Resetear el selector de etiquetas
    tagDropdown.value = '';
    document.getElementById('add-tag-btn').disabled = true;
    
    // Aplicar filtros con las etiquetas seleccionadas
    applyFilters();
}
    
    // Cargar documentos desde Supabase
    async function loadDocuments() {
        try {
            // Obtener recuento total de documentos
            const { count, error: countError } = await supabase
                .from('documents')
                .select('*', { count: 'exact', head: true });
                
            if (countError) throw countError;
            
            totalDocuments = count || 0;
            
            // Obtener documentos para la página actual
            const { data: documents, error } = await supabase
    .from('documents')
    .select('*')
    .order('created_at', { ascending: false })
    .range((currentPage - 1) * documentsPerPage, currentPage * documentsPerPage - 1);
                
            if (error) throw error;
            
            // Guardar todos los documentos cargados para filtrado local
            allDocuments = documents || [];
            
            // Renderizar documentos
            renderDocuments(allDocuments);
            
            // Generar paginación
            generatePagination(totalDocuments, documentsPerPage, currentPage);
            
        } catch (error) {
            console.error('Error al cargar documentos:', error);
            throw error;
        }
    }
    
    // Cargar datos de ejemplo en caso de error con Supabase
    function loadSampleData() {
        const sampleCategories = [
            { id: 1, name: 'Libro' },
            { id: 2, name: 'Personaje' },
            { id: 3, name: 'Tema' }
        ];
        
        const sampleTags = [
            { id: 1, categoryId: 1, name: 'Salmos' },
            { id: 2, categoryId: 1, name: 'Proverbios' },
            { id: 3, categoryId: 2, name: 'David' },
            { id: 4, categoryId: 2, name: 'Salomón' },
            { id: 5, categoryId: 3, name: 'Gracia' },
            { id: 6, categoryId: 3, name: 'Fe' }
        ];
        
        const sampleDocuments = [
            {
                id: 1,
                title: 'Estudio sobre el Salmo 23',
                description: 'Un análisis profundo del Salmo del pastor divino',
                content: '<p>El Salmo 23 es quizás uno de los pasajes más conocidos y amados de toda la Escritura...</p>',
                tags: [
                    { id: 1, name: 'Salmos' },
                    { id: 5, name: 'Gracia' }
                ],
                fileType: 'text',
                fileName: null,
                fileUrl: null,
                createdAt: '2025-05-15T10:30:00'
            },
            {
                id: 2,
                title: 'La vida del rey David',
                description: 'Biografía y legado del rey según el corazón de Dios',
                content: '<p>David, hijo de Isaí de Belén, es una de las figuras más prominentes del Antiguo Testamento...</p>',
                tags: [
                    { id: 3, name: 'David' }
                ],
                fileType: 'text',
                fileName: null,
                fileUrl: null,
                createdAt: '2025-05-10T14:45:00'
            },
            {
                id: 3,
                title: 'La gracia en el Nuevo Testamento',
                description: 'Exploración del concepto teológico de la gracia divina',
                content: '<p>La gracia (del griego "charis") es uno de los conceptos teológicos fundamentales del Nuevo Testamento...</p>',
                tags: [
                    { id: 5, name: 'Gracia' },
                    { id: 6, name: 'Fe' }
                ],
                fileType: 'text',
                fileName: null,
                fileUrl: null,
                createdAt: '2025-05-05T09:15:00'
            }
        ];
        
        // Cargar categorías de ejemplo
const categoryDropdown = document.getElementById('category-dropdown');
categoryDropdown.innerHTML = '<option value="">Selecciona una categoría</option>';

sampleCategories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.id;
    option.textContent = category.name;
    categoryDropdown.appendChild(option);
});

// Guardar datos de ejemplo en las variables globales
allCategories = sampleCategories;
allTags = sampleTags;

// Agregar evento al dropdown de categorías
categoryDropdown.addEventListener('change', handleCategoryChange);        
        // Guardar datos para uso local
        allDocuments = sampleDocuments;
        totalDocuments = sampleDocuments.length;
        
        // Renderizar documentos
        renderDocuments(sampleDocuments);
        
        // Generar paginación
        generatePagination(totalDocuments, documentsPerPage, currentPage);
    }
    
    // Renderizar documentos en la página
    
    function renderDocuments(docs = []) {
    const resultsContainer = document.getElementById('results');
    resultsContainer.innerHTML = '';
    
    // Verificar si el usuario está logueado
    const isLoggedIn = localStorage.getItem('isAdmin') === 'true';
    
    if (docs.length === 0) {
        resultsContainer.innerHTML = '<div class="no-results"><h3>No se encontraron resultados</h3><p>Intenta cambiar tus filtros o términos de búsqueda.</p></div>';
        return;
    }
    
    docs.forEach(doc => {
        const docElement = document.createElement('div');
        docElement.className = 'document-card';
        
        // Crear mapa de etiquetas con nombres reales desde allTags
        const tagsMap = {};
        allTags.forEach(tag => {
            tagsMap[tag.id] = tag.name;
        });
        
        // Generar HTML para las etiquetas usando la función auxiliar
        let tagsHtml = generateTagsHtml(doc, tagsMap);
        
        // Solo mostrar el botón de editar si el usuario está logueado
        const editButton = isLoggedIn ? 
            `<button class="document-edit-btn" data-id="${doc.id}" style="margin-left: 10px; background-color: #e6b742; color: #2a3855;">Editar etiquetas</button>` : '';
            
        docElement.innerHTML = `
    <div class="document-card-content">
        <h3 class="document-title">${doc.title}</h3>
        <p class="document-description">${doc.description}</p>
        <div class="document-tags">
            ${tagsHtml}
        </div>
        <div style="margin-top: 15px;">
            <button class="document-view-btn" data-id="${doc.id}">Ver documento</button>
            ${editButton}
        </div>
    </div>
`;
            
        resultsContainer.appendChild(docElement);
    });
    
    // Agregar eventos a los botones de ver documento
    document.querySelectorAll('.document-view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const docId = parseInt(this.getAttribute('data-id'));
            openDocument(docId);
        });
    });

    // Agregar eventos a los botones de editar etiquetas (solo si existen)
    document.querySelectorAll('.document-edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const docId = parseInt(this.getAttribute('data-id'));
            editDocument(docId);
        });
    });
}
    
   // Abrir documento en la misma ventana
function openDocument(docId) {
    window.location.href = `ver-documento.html?id=${docId}`;
}

    // Abrir editor de etiquetas en nueva pestaña
function editDocument(docId) {
    window.open(`editar-documento.html?id=${docId}`, '_blank');
}
    
    // Búsqueda de documentos
document.getElementById('search-btn').addEventListener('click', function() {
    performSearch();
});

// También permitir búsqueda al presionar Enter
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performSearch();
    }
});

// Función para realizar la búsqueda
async function performSearch() {
    try {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        const searchType = document.querySelector('input[name="search-type"]:checked').value;
        console.log("Realizando búsqueda con término:", searchTerm, "Tipo:", searchType);
        
        // Si no hay término de búsqueda, usar solo las etiquetas seleccionadas
        if (!searchTerm && selectedTagIds.length === 0) {
            currentPage = 1;
            await loadDocuments();
            return;
        }
        
        // Si no hay término pero sí hay etiquetas, usar filtro de etiquetas
        if (!searchTerm && selectedTagIds.length > 0) {
            await applyFilters();
            return;
        }
        
        // Construir consulta según el tipo de búsqueda seleccionado
        let searchQuery;
        if (searchType === 'title') {
            searchQuery = `title.ilike.%${searchTerm}%`;
        } else if (searchType === 'content') {
            searchQuery = `content.ilike.%${searchTerm}%`;
        }
        
        // Realizar búsqueda en Supabase
        const { data, error } = await supabase
            .from('documents')
            .select('*')
            .or(searchQuery)
            .order('created_at', { ascending: false });            
        if (error) throw error;
        
        // Guardar resultados para filtrado adicional
        let filteredDocs = data || [];
        console.log("Resultados de búsqueda:", filteredDocs.length);
        
        // Si hay etiquetas seleccionadas, aplicar filtro adicional
        if (selectedTagIds.length > 0) {
            filteredDocs = filteredDocs.filter(doc => documentHasAllTags(doc, selectedTagIds));
            console.log("Después de filtrar por etiquetas:", filteredDocs.length);
        }
        
        // Actualizar resultados
        allDocuments = filteredDocs;
        totalDocuments = filteredDocs.length;
        renderDocuments(filteredDocs.slice(0, documentsPerPage));
        generatePagination(totalDocuments, documentsPerPage, 1);
        currentPage = 1;
        
    } catch (error) {
        console.error('Error en la búsqueda:', error);
        alert("Ocurrió un error al realizar la búsqueda. Por favor, intente de nuevo.");
    }
}
    
    // Aplicar filtros seleccionados

async function applyFilters() {
    // Obtener término de búsqueda actual
    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
    const searchType = document.querySelector('input[name="search-type"]:checked').value;
    
    // Si no hay etiquetas seleccionadas ni término de búsqueda, mostrar todos los documentos
    if (selectedTagIds.length === 0 && !searchTerm) {
        currentPage = 1;
        await loadDocuments();
        return;
    }
    
    console.log("Aplicando filtros - etiquetas seleccionadas:", selectedTagIds);
    console.log("Término de búsqueda:", searchTerm, "Tipo:", searchType);
    
    try {
        // Iniciar consulta base
        let query = supabase
            .from('documents')
            .select('*')
            .order('created_at', { ascending: false });
        
        // Si hay término de búsqueda, aplicar filtro según el tipo seleccionado
        if (searchTerm) {
            if (searchType === 'title') {
                query = query.ilike('title', `%${searchTerm}%`);
            } else if (searchType === 'content') {
                query = query.ilike('content', `%${searchTerm}%`);
            }
        }            
        // Obtener todos los documentos para filtrar en cliente
        const { data, error } = await query;
        
        if (error) throw error;
        
        // Inicializar filteredDocs con todos los documentos
        let filteredDocs = data || [];
        console.log("Documentos obtenidos:", filteredDocs.length);
        
        // Filtrar por etiquetas en el cliente si hay seleccionadas
        if (selectedTagIds.length > 0) {
            console.log("Filtrando por etiquetas:", selectedTagIds);
            
            filteredDocs = filteredDocs.filter(doc => {
                const hasAllTags = documentHasAllTags(doc, selectedTagIds);
                console.log(`Documento ID ${doc.id}: ${doc.title} - ¿Pasa filtro AND? ${hasAllTags ? 'SÍ' : 'NO'}`);
                return hasAllTags;
            });
            
            console.log(`Después de filtrar por etiquetas: ${filteredDocs.length} documentos`);
        }
        
        // Actualizar variables globales y renderizar resultados
        allDocuments = filteredDocs;
        totalDocuments = filteredDocs.length;
        
        // Mostrar primera página de resultados
        renderDocuments(filteredDocs.slice(0, documentsPerPage));
        generatePagination(totalDocuments, documentsPerPage, 1);
        currentPage = 1;
        
    } catch (error) {
        console.error('Error al aplicar filtros:', error);
        
        // Modo de recuperación: filtrar en cliente con los documentos que ya tenemos
        let filteredDocs = [...allDocuments];
        console.log("Usando modo de recuperación. Documentos disponibles:", filteredDocs.length);
        
        // Aplicar filtro de búsqueda si hay término según el tipo seleccionado
        if (searchTerm) {
            const searchType = document.querySelector('input[name="search-type"]:checked').value;
            if (searchType === 'title') {
                filteredDocs = filteredDocs.filter(doc => 
                    doc.title.toLowerCase().includes(searchTerm)
                );
            } else if (searchType === 'content') {
                filteredDocs = filteredDocs.filter(doc => 
                    doc.content.toLowerCase().includes(searchTerm)
                );
            }
        }
        
        // Filtrar por etiquetas en modo recuperación
        if (selectedTagIds.length > 0) {
            filteredDocs = filteredDocs.filter(doc => documentHasAllTags(doc, selectedTagIds));
        }
        
        // Actualizar UI
        totalDocuments = filteredDocs.length;
        renderDocuments(filteredDocs.slice(0, documentsPerPage));
        generatePagination(totalDocuments, documentsPerPage, 1);
        currentPage = 1;
    }
}
    // Generar paginación
    function generatePagination(totalDocs, docsPerPage = 9, currentPage = 1) {
        const totalPages = Math.ceil(totalDocs / docsPerPage);
        
        // Si solo hay una página, no mostrar paginación
        if (totalPages <= 1) {
            document.getElementById('pagination').style.display = 'none';
            return;
        }
        
        document.getElementById('pagination').style.display = 'flex';
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        // Botón anterior
        const prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn';
        prevBtn.innerHTML = '&laquo; Anterior';
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });
        pagination.appendChild(prevBtn);
        
        // Botones de páginas
        const maxButtons = 5; // Máximo número de botones a mostrar
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        
        // Ajustar si estamos cerca del final
        if (endPage - startPage + 1 < maxButtons && startPage > 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
            pageBtn.textContent = i;
            pageBtn.addEventListener('click', function() {
                goToPage(i);
            });
            pagination.appendChild(pageBtn);
        }
        
        // Botón siguiente
        const nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn';
        nextBtn.innerHTML = 'Siguiente &raquo;';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', function() {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });
        pagination.appendChild(nextBtn);
    }
    
    // Ir a una página específica
    async function goToPage(page) {
        currentPage = page;
        
        try {
            // Obtener documentos para la página específica
           const { data: documents, error } = await supabase
    .from('documents')
    .select('*')
    .order('created_at', { ascending: false })
    .range((currentPage - 1) * documentsPerPage, currentPage * documentsPerPage - 1);
                
            if (error) throw error;
            
            renderDocuments(documents || []);
            generatePagination(totalDocuments, documentsPerPage, page);
            
            // Hacer scroll hacia arriba
            window.scrollTo(0, document.querySelector('.page-content').offsetTop - 100);
            
        } catch (error) {
            console.error('Error al cargar página:', error);
            
            // Paginación local si hay error con Supabase
            const startIndex = (page - 1) * documentsPerPage;
            const endIndex = startIndex + documentsPerPage;
            const pageDocuments = allDocuments.slice(startIndex, endIndex);
            
            renderDocuments(pageDocuments);
            generatePagination(allDocuments.length, documentsPerPage, page);
            
            // Hacer scroll hacia arriba
            window.scrollTo(0, document.querySelector('.page-content').offsetTop - 100);
        }
    }

// Manejo de autenticación
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si el usuario ya está logueado 
    const isLoggedIn = localStorage.getItem('isAdmin') === 'true';
    
    // Actualizar texto del botón según estado
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.textContent = isLoggedIn ? 'Cerrar Sesión' : 'Logearse';
        
        // Configurar el evento de clic
        loginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (isLoggedIn) {
                // Si está logueado, cerrar sesión
                logout();
            } else {
                // Si no está logueado, mostrar modal
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.style.display = 'block';
                }
            }
        });
    }
    
    // Cerrar modal al hacer clic en X
    const closeModalBtn = document.querySelector('.close-modal');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.style.display = 'none';
            }
        });
    }
    
    // Cerrar modal al hacer clic fuera del contenido
    window.addEventListener('click', function(e) {
        const loginModal = document.getElementById('login-modal');
        if (loginModal && e.target == loginModal) {
            loginModal.style.display = 'none';
        }
    });
    
    // Manejar submit del formulario de login
    const submitLoginBtn = document.getElementById('submit-login');
    if (submitLoginBtn) {
        submitLoginBtn.addEventListener('click', handleLogin);
    }
    
    // También permitir login con la tecla Enter
    const adminPasswordInput = document.getElementById('admin-password');
    if (adminPasswordInput) {
        adminPasswordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevenir el envío del formulario
                handleLogin();
            }
        });
    }
});

// Verificar estado de login
function checkLoginStatus() {
    const isLoggedIn = localStorage.getItem('isAdmin') === 'true';
    
    // Actualizar texto del botón según estado
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.textContent = isLoggedIn ? 'Cerrar Sesión' : 'Logearse';
    }
    
    // Recargar documentos para actualizar UI
    if (window.location.pathname.includes('consultar.html')) {
        loadDocuments();
    }
}

// Manejar intento de login
function handleLogin() {
    const password = document.getElementById('admin-password').value;
    const errorElement = document.getElementById('login-error');
    
    // Verificar contraseña
    if (password === 'admin811880') {
        // Guardar estado en localStorage
        localStorage.setItem('isAdmin', 'true');
        
        // Cerrar modal
        document.getElementById('login-modal').style.display = 'none';
        
        // Limpiar campo de contraseña
        document.getElementById('admin-password').value = '';
        
        // Actualizar UI
        errorElement.textContent = '';
        checkLoginStatus();
    } else {
        errorElement.textContent = 'Contraseña incorrecta';
    }
}

// Cerrar sesión
function logout() {
    localStorage.removeItem('isAdmin');
    checkLoginStatus();
}

// Actualizar placeholder según el tipo de búsqueda seleccionado
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchOptions = document.querySelectorAll('input[name="search-type"]');
    
    // Función para actualizar el placeholder
    function updatePlaceholder() {
        const selectedType = document.querySelector('input[name="search-type"]:checked').value;
        if (selectedType === 'title') {
            searchInput.placeholder = 'Buscar por título del documento...';
        } else if (selectedType === 'content') {
            searchInput.placeholder = 'Buscar por contenido del documento...';
        }
    }
    
    // Agregar eventos a los radio buttons
    searchOptions.forEach(option => {
        option.addEventListener('change', updatePlaceholder);
    });
    
    // Establecer placeholder inicial
    updatePlaceholder();
});

</script>

<!-- Modal de Login -->
<div id="login-modal" class="login-modal">
    <div class="login-content">
        <span class="close-modal">&times;</span>
        <h2>Acceso Administrativo</h2>
        <div class="login-form">
            <form>
                <input type="password" id="admin-password" placeholder="Contraseña">
                <button type="button" id="submit-login">Ingresar</button>
            </form>
        </div>
        <div id="login-error" class="login-error"></div>
    </div>
</div>

</body>
</html>

        