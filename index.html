<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumen Logos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
<link rel="stylesheet" href="css/style.css">

</head>
<body>
    <!-- Header -->
    <header>
        <!-- Navigation will be generated by JavaScript -->
    </header>
    <!-- Hero Section -->
    <section class="hero" style="background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('images/1.png'); background-size: cover; background-position: center;">
    <div class="container">
        <h2>Archivo de Reflexiones B√≠blicas</h2>
        <p>Conocimiento B√≠blico en comunidad: comparte, estudia y profundiza</p>

        <div class="hero-buttons">
    <a href="alimentar.html" class="btn btn-secondary">Agregar</a>
    <a href="consultar.html" class="btn btn-secondary">Consultar</a>
</div>

    </div>
</section>

    <!-- Features Section -->
    <section class="features">
        <div class="container">
            <div class="features-grid">
                <div class="feature-box">
                    <div class="feature-icon">
                        
                        <img src="images/icono1.png" alt="Flexible Learning" class="feature-image">

                    </div>
                    <h3 class="feature-title">üïØ L√°mpara a mis pies</h3>
                    <p class="feature-text">"L√°mpara es a mis pies tu palabra, y lumbrera a mi camino." (Salmo 119:105)
En un mundo de tinieblas morales y confusi√≥n espiritual, la Palabra de Dios resplandece como una antorcha viva. Aqu√≠ encontrar√°s verdades eternas que iluminan el sendero del alma, corrigen el coraz√≥n y conducen al peregrino hacia el puerto seguro de la voluntad de Dios. Lumen Logos es ese faro donde cada ense√±anza apunta al resplandor de la verdad revelada.</p>
                    <a href="online-learning.html" class="btn btn-outline">Learn More</a>
                </div>
                <div class="feature-box">
                    <div class="feature-icon">

                        <img src="images/icono2.png" alt="Flexible Learning" class="feature-image">

                    </div>
                    <h3 class="feature-title">‚ú® El Verbo eterno y encarnado</h3>
                    <p class="feature-text">"En el principio era el Verbo, y el Verbo era con Dios, y el Verbo era Dios." (Juan 1:1)
Cristo, el Logos, no es solo Palabra pronunciada, sino Palabra viva, encarnada y glorificada. A trav√©s de √âl, toda revelaci√≥n adquiere forma, todo mensaje encuentra sentido, y todo coraz√≥n puede ser transformado. En este sitio exaltamos al Hijo eterno como la expresi√≥n perfecta del Padre, la Luz verdadera que alumbra a todo hombre.</p>
                    <a href="accreditation.html" class="btn btn-outline">Learn More</a>
                </div>
                <div class="feature-box">
                    <div class="feature-icon">

                        <img src="images/icono3.png" alt="Flexible Learning" class="feature-image">

                    </div>
                    <h3 class="feature-title">üì£ La Voz de la Iglesia</h3>
                    <p class="feature-text">"Predica la palabra; insiste a tiempo y fuera de tiempo." (2 Timoteo 4:2)
La Iglesia ha sido comisionada como heraldo del Verbo. No somos due√±os del mensaje, sino portadores fieles de una Verdad que no puede callarse. Aqu√≠ fortalecemos a quienes proclaman, ense√±an y viven el Evangelio, edificando una comunidad que no solo escucha, sino tambi√©n anuncia con denuedo la gloria de Cristo.</p>
                    <a href="community.html" class="btn btn-outline">Learn More</a>
                </div>
                <div class="feature-box">
                    <div class="feature-icon">

                        <img src="images/icono4.png" alt="Flexible Learning" class="feature-image">

                    </div>
                    <h3 class="feature-title">‚ù§Ô∏è El Hambre del Coraz√≥n Humano</h3

                        <p class="feature-text">"No s√≥lo de pan vivir√° el hombre, sino de toda palabra que sale de la boca de Dios." (Mateo 4:4)
Cada alma anhela sentido, direcci√≥n, redenci√≥n. Solo la Palabra viva puede satisfacer ese clamor profundo. Este espacio es para el sediento, para el que busca luz en medio del quebranto, para quien anhela vida y verdad. Aqu√≠ hallar√°s recursos que alimentan el esp√≠ritu y renuevan el alma mediante el poder del Verbo divino.</p>
                    
                    <a href="community.html" class="btn btn-outline">Learn More</a>

                    </div>
            </div>
        </div>
    </section>
    
    <!-- Agrega el resto de las secciones de tu sitio web aqu√≠ -->

  <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script type="module">
    import { supabase } from './js/supabase-config.js';
    window.supabase = supabase;
</script>
<script src="js/data-manager.js"></script>
<script src="js/scripts.js"></script>

<!-- Modal de Login -->
<div id="login-modal" class="login-modal">
    <div class="login-content">
        <span class="close-modal">&times;</span>
        <h2>Acceso Administrativo</h2>
        <div class="login-form">
            <input type="password" id="admin-password" placeholder="Contrase√±a">
            <button id="submit-login">Ingresar</button>
        </div>
        <div id="login-error" class="login-error"></div>
    </div>
</div>

<style>
/* Estilos Modal Login */
.login-modal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.login-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 300px;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-modal:hover {
    color: black;
}

.login-form {
    margin-top: 20px;
}

.login-form input {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.login-form button {
    width: 100%;
    padding: 10px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.login-form button:hover {
    background-color: var(--secondary-color);
    color: var(--primary-color);
}

.login-error {
    color: #d9534f;
    margin-top: 10px;
    text-align: center;
}

/* Estilos para el men√∫ de b√∫squeda por etiquetas */
.search-menu-item {
    position: relative;
}

.search-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    min-width: 350px;
    max-width: 400px;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    z-index: 1000;
    padding: 0;
}

.search-dropdown-content {
    padding: 20px;
}

.search-header {
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
}

.search-header h4 {
    margin: 0 0 10px 0;
    color: var(--primary-color);
    font-size: 16px;
}

.selected-tags-display {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    min-height: 20px;
}

.selected-tag-chip {
    background: var(--secondary-color);
    color: var(--primary-color);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.selected-tag-chip .remove-tag {
    cursor: pointer;
    font-weight: bold;
}

.categories-container {
    max-height: 300px;
    overflow-y: auto;
}

.category-item {
    margin-bottom: 8px;
}

.category-header {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e9ecef;
    transition: background-color 0.2s;
}

.category-header:hover {
    background: #e9ecef;
}

.category-header.active {
    background: var(--secondary-color);
    color: var(--primary-color);
}

.category-name {
    font-weight: 600;
    font-size: 14px;
}

.category-count {
    font-size: 12px;
    opacity: 0.7;
}

.tags-list {
    display: none;
    padding: 8px 15px;
    background: #fafafa;
    border-left: 3px solid var(--primary-color);
    margin-top: 2px;
}

.tags-list.active {
    display: block;
}

.tag-item {
    padding: 6px 0;
    cursor: pointer;
    font-size: 13px;
    color: #666;
    transition: color 0.2s;
}

.tag-item:hover {
    color: var(--primary-color);
}

.tag-item.selected {
    color: var(--primary-color);
    font-weight: 600;
}

.search-actions {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
}

.btn-search-execute, .btn-clear-tags {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-search-execute {
    background: var(--primary-color);
    color: white;
}

.btn-search-execute:hover:not(:disabled) {
    background: var(--secondary-color);
    color: var(--primary-color);
}

.btn-search-execute:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.btn-clear-tags {
    background: #f8f9fa;
    color: #666;
    border: 1px solid #ddd;
}

.btn-clear-tags:hover {
    background: #e9ecef;
}

.loading-message {
    text-align: center;
    padding: 20px;
    color: #666;
    font-style: italic;
}

/* Responsive para m√≥viles */
@media (max-width: 768px) {
    .search-dropdown {
        right: -50px;
        min-width: 280px;
        max-width: 320px;
    }
    
    .search-dropdown-content {
        padding: 15px;
    }
    
    .categories-container {
        max-height: 250px;
    }
}

</style>

<!-- Scripts for Supabase and Search functionality -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/tag-handler.js"></script>

<script>
// Manejo de autenticaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si el usuario ya est√° logueado 
    checkLoginStatus();
    
    // Manejar click en bot√≥n de login
    document.getElementById('login-btn').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('login-modal').style.display = 'block';
    });
    
    // Cerrar modal al hacer clic en X
    document.querySelector('.close-modal').addEventListener('click', function() {
        document.getElementById('login-modal').style.display = 'none';
    });
    
    // Cerrar modal al hacer clic fuera del contenido
    window.addEventListener('click', function(e) {
        if (e.target == document.getElementById('login-modal')) {
            document.getElementById('login-modal').style.display = 'none';
        }
    });
    
    // Manejar submit del formulario de login
    document.getElementById('submit-login').addEventListener('click', handleLogin);
    
    // Tambi√©n permitir login con la tecla Enter
    document.getElementById('admin-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleLogin();
        }
    });
});

// Verificar estado de login
function checkLoginStatus() {
    const isLoggedIn = localStorage.getItem('isAdmin') === 'true';
    
    // Actualizar texto del bot√≥n seg√∫n estado
    document.getElementById('login-btn').textContent = isLoggedIn ? 'Cerrar Sesi√≥n' : 'Logearse';
    
    // Si est√° logueado, cambiar comportamiento del bot√≥n para cerrar sesi√≥n
    if (isLoggedIn) {
        document.getElementById('login-btn').removeEventListener('click', null);
        document.getElementById('login-btn').addEventListener('click', function(e) {
            e.preventDefault();
            logout();
        });
        
        // Mostrar bot√≥n de "Agregar" 
        const agregarBtn = document.querySelector('.hero-buttons a[href="alimentar.html"]');
        if (agregarBtn) agregarBtn.style.display = 'inline-block';
    } else {
        // Ocultar bot√≥n de "Agregar"
        const agregarBtn = document.querySelector('.hero-buttons a[href="alimentar.html"]');
        if (agregarBtn) agregarBtn.style.display = 'none';
    }
}

// Funcionalidad del men√∫ de b√∫squeda por etiquetas
let searchSelectedTags = [];
let searchAllCategories = [];
let searchAllTags = [];

// Inicializar men√∫ de b√∫squeda
document.addEventListener('DOMContentLoaded', function() {
    initSearchMenu();
});

async function initSearchMenu() {
    // Cargar categor√≠as y etiquetas inteligentes
    await loadSmartCategoriesAndTags();
    
    // Configurar eventos del men√∫
    setupSearchMenuEvents();
}

// Cargar solo categor√≠as y etiquetas que est√°n en uso
async function loadSmartCategoriesAndTags() {
    try {
        // Obtener todas las etiquetas usadas en documentos
        const { data: documents, error: docsError } = await supabase
            .from('documents')
            .select('tags_array');
            
        if (docsError) throw docsError;
        
        // Extraer todas las etiquetas √∫nicas en uso
        const usedTagIds = new Set();
        documents.forEach(doc => {
            const tags = getDocumentTags(doc);
            tags.forEach(tagId => usedTagIds.add(tagId));
        });
        
        // Obtener informaci√≥n de categor√≠as y etiquetas
        const { data: categories, error: catError } = await supabase
            .from('categories')
            .select('*')
            .order('name');
            
        const { data: tags, error: tagsError } = await supabase
            .from('tags')
            .select('*')
            .order('name');
            
        if (catError) throw catError;
        if (tagsError) throw tagsError;
        
        // Filtrar solo etiquetas que est√°n en uso
        const usedTags = tags.filter(tag => usedTagIds.has(tag.id));
        
        // Agrupar etiquetas por categor√≠a
        const categoriesWithTags = categories
            .map(category => ({
                ...category,
                tags: usedTags.filter(tag => tag.category_id === category.id)
            }))
            .filter(category => category.tags.length > 0); // Solo categor√≠as con etiquetas en uso
        
        searchAllCategories = categoriesWithTags;
        searchAllTags = usedTags;
        
        renderSearchCategories();
        
    } catch (error) {
        console.error('Error cargando categor√≠as inteligentes:', error);
        document.getElementById('categories-container').innerHTML = 
            '<div class="loading-message">Error al cargar categor√≠as</div>';
    }
}

function renderSearchCategories() {
    const container = document.getElementById('categories-container');
    container.innerHTML = '';
    
    searchAllCategories.forEach(category => {
        const categoryElement = document.createElement('div');
        categoryElement.className = 'category-item';
        categoryElement.innerHTML = `
            <div class="category-header" data-category-id="${category.id}">
                <span class="category-name">${category.name}</span>
                <span class="category-count">${category.tags.length} etiquetas</span>
            </div>
            <div class="tags-list" id="tags-${category.id}">
                ${category.tags.map(tag => 
                    `<div class="tag-item" data-tag-id="${tag.id}" data-tag-name="${tag.name}">
                        ${tag.name}
                    </div>`
                ).join('')}
            </div>
        `;
        container.appendChild(categoryElement);
    });
}

function setupSearchMenuEvents() {
    // Toggle del men√∫ principal
    document.getElementById('search-menu-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const dropdown = document.getElementById('search-dropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });
    
    // Cerrar men√∫ al hacer clic fuera
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('search-dropdown');
        const menuBtn = document.getElementById('search-menu-btn');
        if (!dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    // Toggle de categor√≠as y selecci√≥n de etiquetas
    document.addEventListener('click', function(e) {
        // Toggle categor√≠a
        if (e.target.closest('.category-header')) {
            const header = e.target.closest('.category-header');
            const categoryId = header.dataset.categoryId;
            const tagsList = document.getElementById(`tags-${categoryId}`);
            
            // Cerrar otras categor√≠as
            document.querySelectorAll('.tags-list.active').forEach(list => {
                if (list.id !== `tags-${categoryId}`) {
                    list.classList.remove('active');
                    list.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle actual
            tagsList.classList.toggle('active');
            header.classList.toggle('active');
        }
        
        // Seleccionar etiqueta
        if (e.target.classList.contains('tag-item')) {
            const tagId = parseInt(e.target.dataset.tagId);
            const tagName = e.target.dataset.tagName;
            
            if (searchSelectedTags.find(t => t.id === tagId)) {
                // Quitar etiqueta
                searchSelectedTags = searchSelectedTags.filter(t => t.id !== tagId);
                e.target.classList.remove('selected');
            } else {
                // Agregar etiqueta
                searchSelectedTags.push({ id: tagId, name: tagName });
                e.target.classList.add('selected');
            }
            
            updateSelectedTagsDisplay();
            updateSearchButton();
        }
    });
    
    // Bot√≥n de b√∫squeda
    document.getElementById('btn-search-execute').addEventListener('click', function() {
        if (searchSelectedTags.length > 0) {
            executeTagSearch();
        }
    });
    
    // Bot√≥n limpiar
    document.getElementById('btn-clear-tags').addEventListener('click', function() {
        clearSelectedTags();
    });
}

function updateSelectedTagsDisplay() {
    const container = document.getElementById('selected-tags-display');
    container.innerHTML = searchSelectedTags.map(tag => 
        `<div class="selected-tag-chip">
            ${tag.name}
            <span class="remove-tag" data-tag-id="${tag.id}">√ó</span>
        </div>`
    ).join('');
    
    // Eventos para quitar etiquetas
    container.querySelectorAll('.remove-tag').forEach(btn => {
        btn.addEventListener('click', function() {
            const tagId = parseInt(this.dataset.tagId);
            searchSelectedTags = searchSelectedTags.filter(t => t.id !== tagId);
            document.querySelector(`[data-tag-id="${tagId}"].tag-item`).classList.remove('selected');
            updateSelectedTagsDisplay();
            updateSearchButton();
        });
    });
}

function updateSearchButton() {
    const btn = document.getElementById('btn-search-execute');
    btn.disabled = searchSelectedTags.length === 0;
}

function clearSelectedTags() {
    searchSelectedTags = [];
    document.querySelectorAll('.tag-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    updateSelectedTagsDisplay();
    updateSearchButton();
}

function executeTagSearch() {
    const selectedTagIds = searchSelectedTags.map(t => t.id);
    const searchUrl = `consultar.html?tags=${selectedTagIds.join(',')}`;
    window.location.href = searchUrl;
}

// Funci√≥n auxiliar para manejar etiquetas (necesaria para el men√∫ inteligente)
function getDocumentTags(doc) {
    if (doc.tags_array && Array.isArray(doc.tags_array)) {
        return doc.tags_array.map(tag => Number(tag));
    }
    
    if (!doc || !doc.tags) return [];
    
    if (Array.isArray(doc.tags)) {
        return doc.tags.map(tag => Number(tag));
    }
    
    if (typeof doc.tags === 'number' || typeof doc.tags === 'string') {
        return [Number(doc.tags)];
    }
    
    return [Number(doc.tags)];
}

// Manejar intento de login
async function handleLogin() {
    const password = document.getElementById('admin-password').value;
    const errorElement = document.getElementById('login-error');
    
    try {
        // Primero, generamos el hash de la contrase√±a
        const hashedPassword = await hashPassword(password);
        
        // Luego verificamos con la funci√≥n RPC
        const { data, error } = await supabase.rpc('verify_admin_password', {
            pass: hashedPassword
        });
        
        if (error) {
            throw error;
        }
        
        if (data === true) {
            // Contrase√±a correcta - guardar estado
            localStorage.setItem('isAdmin', 'true');
            
            // Cerrar modal
            document.getElementById('login-modal').style.display = 'none';
            
            // Limpiar campo de contrase√±a
            document.getElementById('admin-password').value = '';
            
            // Actualizar UI
            errorElement.textContent = '';
            checkLoginStatus();
        } else {
            errorElement.textContent = 'Contrase√±a incorrecta';
        }
    } catch (error) {
        console.error('Error al verificar credenciales:', error.message);
        errorElement.textContent = 'Error al verificar. Intente nuevamente.';
    }
}

// Funci√≥n para hashear la contrase√±a
async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Cerrar sesi√≥n
function logout() {
    localStorage.removeItem('isAdmin');
    checkLoginStatus();
}


// Ocultar bot√≥n "Agregar" si no est√° logueado al cargar la p√°gina
window.addEventListener('DOMContentLoaded', function() {
    const isLoggedIn = localStorage.getItem('isAdmin') === 'true';
    const agregarBtn = document.querySelector('.hero-buttons a[href="alimentar.html"]');
    if (agregarBtn && !isLoggedIn) {
        agregarBtn.style.display = 'none';
    }
});
</script>

</body>
</html>
